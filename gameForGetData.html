<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Motion Recorder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    input {
      font-size: 1.2rem;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
    }
    button {
      padding: 20px;
      font-size: 1.5rem;
      width: 100%;
      border: none;
      border-radius: 10px;
      background-color: #007bff;
      color: white;
      margin-top: 10px;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #motion, #status {
      background-color: #f4f4f4;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-size: 1rem;
    }
    h2 {
      text-align: center;
    }
    #instruction {
      font-size: 1rem;
      font-weight: bold;
      color: #555;
      margin-bottom: 5px;
      white-space: pre-line;
    }
    #progressContainer {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #28a745;
      transition: width linear;
    }
    /* animation for the user */
    #circle-container {
      width: 300px;
      height: 300px;
      margin: auto;
    }
    #vector {
      transform-origin: 150px 150px;
      transition: transform linear;
    }
  </style>
</head>
<body>

<!-- SETUP -->
<div id="setup">
  <div id="instruction">Step 1: Enter Your Information
Please enter your name and the exact model of your smartphone. This information is optional — if you prefer not to share it, you can simply write “unknown”.

In the next steps, you will perform physical movements while holding your phone in your hand. After completing all steps, you will be able to download your motion data and send it via email to the Virtual UTTOP group. The email address will be shown at the end.

Important:
Hold your phone naturally — as if you were using it for navigation while walking.
Make sure you have enough space to turn, walk, and use a staircase safely.
Be especially careful when going up or down the stairs.
The entire session will take around 5 minutes.

Thank you for your support — and enjoy this short movement session!
</div>
  <h2>Motion Recorder Setup</h2>
  <input id="name" placeholder="Enter your name">
  <input id="device" placeholder="Enter phone model">
  <button onclick="startExperiment()">OK</button>
</div>

<!-- EXPERIMENT -->
<div id="experiment" style="display:none;">
  <div id="experimentInstruction"></div> 
  <h2 id="stepTitle"></h2>
  <div class="counter" id="counterDisplay"></div>
  <div id="status">Ready.</div>
  <div id="progressContainer"><div id="progressBar"></div></div>
  <div id="motion">Waiting for data...</div>
  <button id="nextButton" onclick="startMeasurement()">Start Measurement</button>
</div>
<!-- circle Container -->
<div id="circle-container"style="display: none;">
  <button id="nextAnimation" onclick="startAnimation()">Start Animation</button>
  <svg width="300" height="300">
    <circle cx="150" cy="150" r="100" stroke="black" stroke-width="2" fill="none"/>
    <line id="vector" x1="150" y1="150" x2="250" y2="150" stroke="red" stroke-width="4" />
  </svg>
</div>  

<!-- DONE -->
<div id="done" style="display:none;">
  <div id="instruction">Step 15: Send Your Data
You’ve completed the session — thank you!

Now press the Download button to save the recorded motion data as a CSV file.
Please send the file via email to:

sebastian.meyer@etudiant.uttop.fr

Important note:
If you feel that the movements were not performed correctly, please do not send the data.
You may repeat the session as many times as you like.
Feel free to use it as a short and active break in your daily routine.

Thank you again for your time and your valuable contribution to the Virtual UTTOP project!
</div>
  <h2>Recording complete</h2>
  <button onclick="downloadCSV()">⬇ Download CSV</button>
</div>

<script>
  const measurementDuration = 2900;
  let currentAngle = 0;

  const stepDescriptions = [
    "", // Step 0 (Setup)
    "Get Ready\nHold your phone steady in your hand, in the position described above.\nWhen you press the Start button, the system will record your movement for 3 seconds.\nNote: Recording starts only after you press Start.",
    "Step 1: Read the instructions carefully.\n Step 2: Press the Button to start the measurement.\n Step 3: Turn left for 90° degree. Try to turn so long as the green bar load is loading.\n Step 4: Repat this 10 times.\n You can use the button to start the animation for training.",
    "Get Ready\nHold your phone still in your hand.\nPress the Start button and wait while your movement is recorded for 3 seconds.",
    "Step 1: Read the instructions carefully.\n Step 2: Press the Button to start the measurement.\n Step 3: Turn right for 90° degree. Try to turn so long as the green bar load is loading.\n Step 4: Repat this 10 times.",
    "Get Ready\nHold your phone still in your hand.",
    "Step 1: Read the instructions carefully.\n Step 2: Press the Button to start the measurement.\n Step 3: Walk forward so long as the green bar load is loading.\n Step 4: Repat this 10 times.",
    "Get Ready\nHold your phone still.",
    "Step 1: Read the instructions carefully.\n Step 2: Press the Button to start the measurement.\n Step 3: Walk backforward so long as the green bar load is loading.\n Step 4: Repat this 10 times.",
    " Get Ready\nHold your phone still.",
    "Step 1: Read the instructions carefully.\n Step 2: Press the Button to start the measurement.\n Step 3:Walk up a staircase slowly and carefully so long as the green bar load is loading.\n Step 4: Repat this 10 times.",
    " Get Ready\nHold your phone still.",
    "Step 1: Read the instructions carefully.\n Step 2: Press the Button to start the measurement.\n Step 3:Walk down a staircase slowly and carefully so long as the green bar load is loading.\n Step 4: Repat this 10 times.",
    " Final Pause \nHold your phone still.\nRepeat this three times."
  ];

  let steps = [
    { label: "wait", count: 1 },
    { label: "left", count: 10 },
    { label: "wait", count: 1 },
    { label: "right", count: 10 },
    { label: "wait", count: 1 },
    { label: "forward", count: 10 },
    { label: "wait", count: 1 },
    { label: "backward", count: 10 },
    { label: "wait", count: 1 },
    { label: "stairs_up", count: 10 },
    { label: "wait", count: 1 },
    { label: "stairs_down", count: 10 },
    { label: "wait", count: 3 }
  ];

  let userName = "", userDevice = "", currentStep = 0, repetition = 0;
  let motionData = [], recording = false, recordingStartTime = 0, lastSampleTime = 0;
  const minSampleInterval = 100;

  function startExperiment() {
    userName = document.getElementById("name").value.trim();
    userDevice = document.getElementById("device").value.trim();

    if (!userName || !userDevice) {
      alert("Please enter your name and device.");
      return;
    }

    document.getElementById("setup").style.display = "none";
    document.getElementById("experiment").style.display = "block";
    enableMotionListener();
    updateStepDisplay();
  }

  function enableMotionListener() {
    if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
      DeviceMotionEvent.requestPermission().then(permission => {
        if (permission === "granted") window.addEventListener("devicemotion", handleMotion);
        else alert("Motion permission denied.");
      }).catch(alert);
    } else {
      window.addEventListener("devicemotion", handleMotion);
    }
  }

  function handleMotion(event) {
    const now = Date.now();
    if (!recording || now - lastSampleTime < minSampleInterval) return;
    lastSampleTime = now;

    const acc = event.acceleration || {}, rot = event.rotationRate || {};
    const time = now - recordingStartTime;
    const label = steps[currentStep].label;
    const segment = `${label}_${repetition + 1}`;

    motionData.push([
      time, acc.x ?? "", acc.y ?? "", acc.z ?? "",
      rot.alpha ?? "", rot.beta ?? "", rot.gamma ?? "",
      label, segment
    ]);

    document.getElementById("motion").innerHTML =
      `Acc: x=${acc.x?.toFixed(2) ?? "?"}, y=${acc.y?.toFixed(2) ?? "?"}, z=${acc.z?.toFixed(2) ?? "?"} |
       Rot: α=${rot.alpha?.toFixed(2) ?? "?"}, β=${rot.beta?.toFixed(2) ?? "?"}, γ=${rot.gamma?.toFixed(2) ?? "?"}`;
  }

  function updateStepDisplay() {
    const step = steps[currentStep];
    document.getElementById("stepTitle").textContent = `Perform: ${step.label}`;
    document.getElementById("counterDisplay").textContent = `${repetition + 1} / ${step.count}`;
    document.getElementById("experimentInstruction").textContent = stepDescriptions[currentStep + 1] || "";
    document.getElementById("status").textContent = "Press start for next segment.";
    document.getElementById("progressBar").style.width = "0%";
    if(currentStep == 1){
      document.getElementById("circle-container").style.display = "block";
    }else{
      document.getElementById("circle-container").style.display = "none";
    }
  }

  function startMeasurement() {
    const btn = document.getElementById("nextButton");
    const progress = document.getElementById("progressBar");

    btn.disabled = true;
    btn.style.backgroundColor = "#28a745";
    recording = true;
    recordingStartTime = Date.now();
    document.getElementById("status").textContent = "Recording...";

    progress.style.transition = "none";
    progress.style.width = "0%";
    void progress.offsetWidth;
    progress.style.transition = `width ${measurementDuration}ms linear`;
    progress.style.width = "100%";

    setTimeout(() => {
      recording = false;
      document.getElementById("status").textContent = "Done.";
      btn.disabled = false;
      btn.style.backgroundColor = "#007bff";
      progress.style.transition = "none";
      progress.style.width = "0%";

      repetition++;
      if (repetition >= steps[currentStep].count) {
        repetition = 0;
        currentStep++;
        if (currentStep >= steps.length) {
          document.getElementById("experiment").style.display = "none";
          document.getElementById("done").style.display = "block";
          return;
        }
      }
      updateStepDisplay();
    }, measurementDuration);
  }

  function downloadCSV() {
    const safeName = userName.replace(/\s+/g, "_").toLowerCase();
    const safeDevice = userDevice.replace(/\s+/g, "_").toLowerCase();
    const filename = `motion_${safeName}_${safeDevice}.csv`;
    const csv = [
      "time_ms,acc_x,acc_y,acc_z,gyro_x,gyro_y,gyro_z,label,segment_id",
      ...motionData.map(row => row.join(","))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
  function startAnimation() {
    const vector = document.getElementById("vector");
    const progress = document.getElementById("progressBar");

    currentAngle -= 90;
    vector.style.transition = `transform ${measurementDuration}ms linear`;
    vector.style.transform = `rotate(${currentAngle}deg)`;

    progress.style.transition = `width ${measurementDuration}ms linear`;
    progress.style.width = "100%";

    setTimeout(() => {
      progress.style.transition = "none";
      progress.style.width = "0%";
      setTimeout(() => {
        progress.style.transition = `width ${measurementDuration}ms linear`;
      }, 50);
    }, measurementDuration + 50);
  }

</script>

</body>
</html>
