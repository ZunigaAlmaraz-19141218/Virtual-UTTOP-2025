<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Motion Sensor CSV Logger with Markers</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin-bottom: 10px;
      margin-right: 10px;
    }
    #output, #motion, #marker-feedback {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f4f4f4;
      border: 1px solid #ccc;
    }
    #map {
      height: 400px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h1>Motion Sensor CSV Logger with Markers</h1>

  <button onclick="startGPS()">Get GPS Location</button>
  <button onclick="startRecording()">Start Recording</button>
  <button onclick="stopRecording()">Stop Recording</button>

  <br>

  <button onclick="markEvent('P1')">Mark Point 1</button>
  <button onclick="markEvent('P2')">Mark Point 2</button>
  <button onclick="markEvent('P3')">Mark Point 3</button>
  <button onclick="markEvent('P4')">Mark Point 4</button>
  <button onclick="markEvent('P5')">Mark Point 5</button>

  <br>

  <button onclick="markEvent('ROTATION_90_LEFT')">Rotation Left 90°</button>
  <button onclick="markEvent('ROTATION_90_RIGHT')">Rotation Right 90°</button>
  <button onclick="markEvent('MOVE_FORWARD')">Move Forward</button>
  <button onclick="markEvent('MOVE_BACKWARD')">Move Backward</button>

  <div id="output">No location data received yet.</div>
  <div id="motion">No motion sensor data received yet.</div>
  <div id="marker-feedback">No marker set yet.</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let map, marker = null, accuracyCircle = null;
    let recording = false;
    let motionData = [];
    let listenerActive = false;
    let lastSampleTime = 0;
    const minSampleInterval = 100;
    let recordingStartTime = 0;
    let currentEvent = "";

    function initMap() {
      map = L.map('map').setView([43.0, 0.0], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    function startGPS() {
      const output = document.getElementById("output");
      if (!navigator.geolocation) {
        output.textContent = "Geolocation is not supported by this browser.";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude, accuracy, altitude } = position.coords;
          output.innerHTML = `
            <strong>Latitude:</strong> ${latitude.toFixed(6)}<br>
            <strong>Longitude:</strong> ${longitude.toFixed(6)}<br>
            <strong>Accuracy:</strong> ±${accuracy.toFixed(1)} meters<br>
            <strong>Altitude:</strong> ${altitude ? altitude.toFixed(2) + " m" : "Not available"}
          `;
          map.setView([latitude, longitude], 18);
          if (marker) {
            marker.setLatLng([latitude, longitude]);
            accuracyCircle.setLatLng([latitude, longitude]).setRadius(accuracy);
          } else {
            marker = L.marker([latitude, longitude]).addTo(map).bindPopup("Your location").openPopup();
            accuracyCircle = L.circle([latitude, longitude], {
              radius: accuracy,
              color: 'blue',
              fillColor: '#cce5ff',
              fillOpacity: 0.3
            }).addTo(map);
          }
        },
        (error) => {
          output.textContent = "Error: " + error.message;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    function handleMotion(event) {
      const now = Date.now();
      if (now - lastSampleTime < minSampleInterval) return;
      lastSampleTime = now;

      const acc = event.acceleration || {};
      const relativeTime = (now - recordingStartTime).toFixed(0);

      document.getElementById("motion").innerHTML = `
        <strong>Acceleration (no gravity):</strong><br>
        X: ${acc.x?.toFixed(2) ?? "?"} m/s²<br>
        Y: ${acc.y?.toFixed(2) ?? "?"} m/s²<br>
        Z: ${acc.z?.toFixed(2) ?? "?"} m/s²<br><br>
        <strong>Time:</strong> ${relativeTime} ms since start
      `;

      if (recording) {
        motionData.push([
          relativeTime,
          acc.x ?? "", acc.y ?? "", acc.z ?? "",
          currentEvent
        ]);
        currentEvent = "";
      }
    }

    function startRecording() {
      motionData = [];
      recording = true;
      recordingStartTime = Date.now();
      document.getElementById("marker-feedback").textContent = "Recording started.";

      if (listenerActive) return;

      function enableListener() {
        window.addEventListener("devicemotion", handleMotion);
        listenerActive = true;
      }

      if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        DeviceMotionEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === "granted") enableListener();
            else {
              document.getElementById("motion").textContent = "Permission denied.";
              recording = false;
            }
          })
          .catch(err => {
            document.getElementById("motion").textContent = "Permission error: " + err;
            recording = false;
          });
      } else if (typeof DeviceMotionEvent !== "undefined") {
        enableListener();
      } else {
        document.getElementById("motion").textContent = "Motion sensor not supported.";
        recording = false;
      }
    }

    function stopRecording() {
      if (listenerActive) {
        window.removeEventListener("devicemotion", handleMotion);
        listenerActive = false;
      }
      recording = false;
      document.getElementById("motion").textContent = "Recording stopped.";

      if (motionData.length > 0) {
        const csvRows = [
          "time_ms,acc_x,acc_y,acc_z,event",
          ...motionData.map(row => row.join(","))
        ];
        const csvBlob = new Blob([csvRows.join("\n")], { type: "text/csv" });

        const now = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const filename = `motion_recording_${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_` +
                         `${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.csv`;

        const url = URL.createObjectURL(csvBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    }

    function markEvent(label) {
      if (!recording) return;
      const now = Date.now();
      const relative = (now - recordingStartTime);
      currentEvent = label;
      document.getElementById("marker-feedback").innerHTML =
        `Marked <strong>${label}</strong> at <strong>${relative} ms</strong>`;
    }

    window.onload = function() {
      initMap();
      startGPS();
    };
  </script>

</body>
</html>
